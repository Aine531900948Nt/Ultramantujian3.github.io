<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试 - 奥特曼图鉴大全</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-item {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-pass { border-color: #28a745; background-color: #f8fff9; }
        .test-fail { border-color: #dc3545; background-color: #fff8f8; }
        .test-pending { border-color: #ffc107; background-color: #fffef5; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">奥特曼图鉴功能测试</h1>
        
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="test-item test-pending" id="test-files">
                    <h5>📁 文件完整性检查</h5>
                    <p>检查所有必需文件是否存在...</p>
                    <ul id="file-list"></ul>
                </div>

                <div class="test-item test-pending" id="test-modules">
                    <h5>🔧 模块加载测试</h5>
                    <p>检查所有JavaScript模块是否正确加载...</p>
                    <ul id="module-list"></ul>
                </div>

                <div class="test-item test-pending" id="test-ui">
                    <h5>🎨 UI组件测试</h5>
                    <p>测试界面组件渲染功能...</p>
                    <ul id="ui-list"></ul>
                </div>

                <div class="test-item test-pending" id="test-storage">
                    <h5>💾 本地存储测试</h5>
                    <p>测试localStorage和收藏功能...</p>
                    <ul id="storage-list"></ul>
                </div>

                <div class="test-item test-pending" id="test-responsive">
                    <h5>📱 响应式设计测试</h5>
                    <p>测试不同屏幕尺寸的适配...</p>
                    <ul id="responsive-list"></ul>
                </div>

                <div class="test-summary mt-4 p-3 bg-light rounded">
                    <h5>测试摘要</h5>
                    <div id="test-results">
                        <p>正在运行测试...</p>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <a href="index.html" class="btn btn-primary btn-lg">
                        <i class="fas fa-home"></i> 进入主应用
                    </a>
                    <button class="btn btn-secondary btn-lg ms-2" onclick="runTests()">
                        <i class="fas fa-redo"></i> 重新测试
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        class FunctionTester {
            constructor() {
                this.tests = [];
                this.passedTests = 0;
                this.failedTests = 0;
            }

            async runAllTests() {
                console.log('开始功能测试...');
                
                await this.testFileIntegrity();
                await this.testModuleLoading();
                await this.testUIComponents();
                await this.testLocalStorage();
                await this.testResponsiveDesign();
                
                this.showTestSummary();
            }

            async testFileIntegrity() {
                const fileTest = document.getElementById('test-files');
                const fileList = document.getElementById('file-list');
                
                const requiredFiles = [
                    'index.html',
                    'css/main.css',
                    'js/bmob-config.js',
                    'js/data-service.js',
                    'js/ui-components.js',
                    'js/search.js',
                    'js/favorites.js',
                    'js/comparison.js',
                    'js/timeline.js',
                    'js/developer.js',
                    'js/main.js',
                    'README.md'
                ];

                let allFilesExist = true;
                
                for (const file of requiredFiles) {
                    try {
                        const response = await fetch(file);
                        const exists = response.ok;
                        
                        const li = document.createElement('li');
                        li.innerHTML = `${file} - ${exists ? 
                            '<span class="text-success">✓ 存在</span>' : 
                            '<span class="text-danger">✗ 缺失</span>'}`;
                        fileList.appendChild(li);
                        
                        if (!exists) allFilesExist = false;
                    } catch (error) {
                        const li = document.createElement('li');
                        li.innerHTML = `${file} - <span class="text-danger">✗ 检查失败</span>`;
                        fileList.appendChild(li);
                        allFilesExist = false;
                    }
                }

                if (allFilesExist) {
                    fileTest.className = 'test-item test-pass';
                    this.passedTests++;
                } else {
                    fileTest.className = 'test-item test-fail';
                    this.failedTests++;
                }
            }

            async testModuleLoading() {
                const moduleTest = document.getElementById('test-modules');
                const moduleList = document.getElementById('module-list');
                
                // 加载主应用脚本
                try {
                    await this.loadScript('js/bmob-config.js');
                    await this.loadScript('js/data-service.js');
                    await this.loadScript('js/ui-components.js');
                    await this.loadScript('js/search.js');
                    await this.loadScript('js/favorites.js');
                    await this.loadScript('js/comparison.js');
                    await this.loadScript('js/timeline.js');
                    await this.loadScript('js/developer.js');
                    await this.loadScript('js/main.js');
                    
                    const modules = [
                        { name: 'DataService', obj: 'dataService' },
                        { name: 'UIComponents', obj: 'uiComponents' },
                        { name: 'SearchModule', obj: 'searchModule' },
                        { name: 'FavoritesManager', obj: 'favoritesManager' },
                        { name: 'ComparisonSystem', obj: 'comparisonSystem' },
                        { name: 'TimelineModule', obj: 'timelineModule' },
                        { name: 'DeveloperMode', obj: 'developerMode' }
                    ];

                    let allModulesLoaded = true;

                    for (const module of modules) {
                        const exists = window[module.obj] !== undefined;
                        const li = document.createElement('li');
                        li.innerHTML = `${module.name} - ${exists ? 
                            '<span class="text-success">✓ 已加载</span>' : 
                            '<span class="text-danger">✗ 未加载</span>'}`;
                        moduleList.appendChild(li);
                        
                        if (!exists) allModulesLoaded = false;
                    }

                    if (allModulesLoaded) {
                        moduleTest.className = 'test-item test-pass';
                        this.passedTests++;
                    } else {
                        moduleTest.className = 'test-item test-fail';
                        this.failedTests++;
                    }

                } catch (error) {
                    moduleList.innerHTML = `<li class="text-danger">模块加载失败: ${error.message}</li>`;
                    moduleTest.className = 'test-item test-fail';
                    this.failedTests++;
                }
            }

            testUIComponents() {
                const uiTest = document.getElementById('test-ui');
                const uiList = document.getElementById('ui-list');
                
                const tests = [
                    {
                        name: 'Bootstrap CSS',
                        test: () => document.querySelector('link[href*="bootstrap"]') !== null
                    },
                    {
                        name: 'Font Awesome',
                        test: () => document.querySelector('link[href*="font-awesome"]') !== null || 
                                   document.querySelector('script[src*="font-awesome"]') !== null
                    },
                    {
                        name: 'Chart.js',
                        test: () => window.Chart !== undefined
                    },
                    {
                        name: 'Bootstrap JS',
                        test: () => window.bootstrap !== undefined
                    }
                ];

                let allTestsPassed = true;

                tests.forEach(test => {
                    const passed = test.test();
                    const li = document.createElement('li');
                    li.innerHTML = `${test.name} - ${passed ? 
                        '<span class="text-success">✓ 正常</span>' : 
                        '<span class="text-danger">✗ 异常</span>'}`;
                    uiList.appendChild(li);
                    
                    if (!passed) allTestsPassed = false;
                });

                if (allTestsPassed) {
                    uiTest.className = 'test-item test-pass';
                    this.passedTests++;
                } else {
                    uiTest.className = 'test-item test-fail';
                    this.failedTests++;
                }
            }

            testLocalStorage() {
                const storageTest = document.getElementById('test-storage');
                const storageList = document.getElementById('storage-list');
                
                const tests = [
                    {
                        name: 'localStorage 支持',
                        test: () => {
                            try {
                                localStorage.setItem('test', 'value');
                                localStorage.removeItem('test');
                                return true;
                            } catch (e) {
                                return false;
                            }
                        }
                    },
                    {
                        name: 'JSON 序列化',
                        test: () => {
                            try {
                                const obj = { test: 'value' };
                                const str = JSON.stringify(obj);
                                const parsed = JSON.parse(str);
                                return parsed.test === 'value';
                            } catch (e) {
                                return false;
                            }
                        }
                    },
                    {
                        name: '收藏功能基础',
                        test: () => {
                            try {
                                if (!window.favoritesManager) return false;
                                return typeof window.favoritesManager.toggleFavorite === 'function';
                            } catch (e) {
                                return false;
                            }
                        }
                    }
                ];

                let allTestsPassed = true;

                tests.forEach(test => {
                    const passed = test.test();
                    const li = document.createElement('li');
                    li.innerHTML = `${test.name} - ${passed ? 
                        '<span class="text-success">✓ 正常</span>' : 
                        '<span class="text-danger">✗ 异常</span>'}`;
                    storageList.appendChild(li);
                    
                    if (!passed) allTestsPassed = false;
                });

                if (allTestsPassed) {
                    storageTest.className = 'test-item test-pass';
                    this.passedTests++;
                } else {
                    storageTest.className = 'test-item test-fail';
                    this.failedTests++;
                }
            }

            testResponsiveDesign() {
                const responsiveTest = document.getElementById('test-responsive');
                const responsiveList = document.getElementById('responsive-list');
                
                const tests = [
                    {
                        name: 'Viewport 元标签',
                        test: () => document.querySelector('meta[name="viewport"]') !== null
                    },
                    {
                        name: 'Bootstrap Grid 系统',
                        test: () => document.querySelector('.container, .container-fluid') !== null
                    },
                    {
                        name: 'CSS 媒体查询支持',
                        test: () => window.matchMedia !== undefined
                    },
                    {
                        name: '屏幕尺寸检测',
                        test: () => {
                            return window.innerWidth > 0 && window.innerHeight > 0;
                        }
                    }
                ];

                let allTestsPassed = true;

                tests.forEach(test => {
                    const passed = test.test();
                    const li = document.createElement('li');
                    li.innerHTML = `${test.name} - ${passed ? 
                        '<span class="text-success">✓ 正常</span>' : 
                        '<span class="text-danger">✗ 异常</span>'}`;
                    responsiveList.appendChild(li);
                    
                    if (!passed) allTestsPassed = false;
                });

                if (allTestsPassed) {
                    responsiveTest.className = 'test-item test-pass';
                    this.passedTests++;
                } else {
                    responsiveTest.className = 'test-item test-fail';
                    this.failedTests++;
                }
            }

            showTestSummary() {
                const resultsDiv = document.getElementById('test-results');
                const totalTests = this.passedTests + this.failedTests;
                
                resultsDiv.innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="text-success">
                                <h4>${this.passedTests}</h4>
                                <p>通过测试</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-danger">
                                <h4>${this.failedTests}</h4>
                                <p>失败测试</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-info">
                                <h4>${Math.round((this.passedTests / totalTests) * 100)}%</h4>
                                <p>通过率</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        ${this.failedTests === 0 ? 
                            '<div class="alert alert-success">🎉 所有测试通过！应用已准备就绪。</div>' :
                            '<div class="alert alert-warning">⚠️ 部分测试失败，请检查上述错误并修复。</div>'
                        }
                    </div>
                `;
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
        }

        // 页面加载完成后自动运行测试
        document.addEventListener('DOMContentLoaded', function() {
            const tester = new FunctionTester();
            tester.runAllTests();
        });

        // 重新测试功能
        function runTests() {
            location.reload();
        }
    </script>
</body>
</html>